services:
  reach-backend:
    image: registry.reachsdk.online/reach-backend:latest
    container_name: reach-backend
    networks:
      - frontend
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - PORT=3000
      - MULTER_DIR=/app/cdn
      - NODE_ENV=production
    labels:
      # Traefik reverse proxy configuration
      - traefik.enable=true
      # HTTP router (redirect to HTTPS)
      - traefik.http.routers.reach-http.rule=Host(`api.reachx.dev`)
      - traefik.http.routers.reach-http.entrypoints=web
      - traefik.http.routers.reach-http.middlewares=redirect-to-https
      # HTTPS router
      - traefik.http.routers.reach-https.rule=Host(`api.reachx.dev`)
      - traefik.http.routers.reach-https.entrypoints=websecure
      - traefik.http.routers.reach-https.tls=true
      - traefik.http.routers.reach-https.tls.certresolver=cloudflare
      # Service configuration
      - traefik.http.services.reach-backend.loadbalancer.server.port=3000
      # Middleware for HTTPS redirect
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true
    volumes:
      # Persistent storage for CDN files
      - reach-cdn-data:/app/cdn
    restart: unless-stopped
    pull_policy: always
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  reach-cdn-data:
    driver: local

networks:
  frontend:
    external: true